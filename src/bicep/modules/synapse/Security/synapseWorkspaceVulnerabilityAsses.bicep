///////////////////////////////////////////////////////////////////////////////////////////////////////
// Copyright (c) 2021-2022 Microsoft Corporation. All rights reserved. This
// Software is licensed under the MIT License. See LICENSE in the project root
// for license information.
///////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Module Description : 
// This module implements vulnerabilty assesment for SQL pool
//
// Assign appropriate values as needed. If needed override global parameters
//
///////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////
// Section for Bicep parameters
///////////////////////////////////////////////////////////////////////////////////////////////////////

@description('Prefix for  Synapse Workspace Name.')
param p_workspaceName string

@description('List of email addresses to which scan notification is sent')
param p_vulnerabilityScanEmails array 

@description('schedule scan notification will be is sent to the subscription administrators.')
param p_emailSubscriptionAdmins bool = true

@description('Enable recurring scan state')
param p_isRecurringScanEnabled bool = true

@description('Storage access key for storing vulnerability assessment scan results')
param p_storageAccountAccessKey string

@description('Storage blob name for storing vulnerability assessment scan results')
param p_storageContainerName string 

@description('Storage endpoint for storing vulnerability assessment scan results')
param p_storageBlobPrimaryEndpoint string 


///////////////////////////////////////////////////////////////////////////////////////////////////////
// Section for Bicep variables
///////////////////////////////////////////////////////////////////////////////////////////////////////

var v_storageContainerName = split(p_storageContainerName,'/')[2]
var v_storageContainerPath = '${p_storageBlobPrimaryEndpoint}${v_storageContainerName}'


///////////////////////////////////////////////////////////////////////////////////////////////////////
// Section for Bicep resources
///////////////////////////////////////////////////////////////////////////////////////////////////////

resource synapseWorkspace 'Microsoft.Synapse/workspaces@2021-06-01'  existing = {
  name: p_workspaceName
  }

resource synapseVulnerabilityAssesment 'Microsoft.Synapse/workspaces/vulnerabilityAssessments@2021-06-01' = {
  name: 'default'
  parent: synapseWorkspace
  properties: {
    recurringScans: {
      emails: p_vulnerabilityScanEmails
      emailSubscriptionAdmins: p_emailSubscriptionAdmins
      isEnabled: p_isRecurringScanEnabled
    }
    storageAccountAccessKey: p_storageAccountAccessKey
    storageContainerPath: v_storageContainerPath
  }
}

///////////////////////////////////////////////////////////////////////////////////////////////////////
// Section for Bicep Output
///////////////////////////////////////////////////////////////////////////////////////////////////////
