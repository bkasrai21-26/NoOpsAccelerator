///////////////////////////////////////////////////////////////////////////////////////////////////////
// Copyright (c) 2021-2022 Microsoft Corporation. All rights reserved. This
// Software is licensed under the MIT License. See LICENSE in the project root
// for license information.
///////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Module Description : 
// This module implements vulnerabilty assesment for SQL databases
//
// Assign appropriate values as needed. If needed override global parameters
//
///////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////
// Section for Bicep parameters
///////////////////////////////////////////////////////////////////////////////////////////////////////

@description('List of email addresses to which scan notification is sent')
param p_vulnerabilityScanEmails array 

@description('schedule scan notification will be is sent to the subscription administrators.')
param p_emailSubscriptionAdmins bool = true

@description('Enable recurring scan state')
param p_isRecurringScanEnabled bool = true

@description('Storage access key for storing vulnerability assessment scan results')
param p_storageAccountAccessKey string

@description('Storage blob name for storing vulnerability assessment scan results')
param p_storageContainerName string 

@description('Storage endpoint for storing vulnerability assessment scan results')
param p_storageBlobPrimaryEndpoint string 

@description('Name of SQL server')
param p_sqlServerName string

@description('SQL database name')
param p_sqlDBName string



///////////////////////////////////////////////////////////////////////////////////////////////////////
// Section for Bicep variables
///////////////////////////////////////////////////////////////////////////////////////////////////////

var v_storageContainerName = split(p_storageContainerName,'/')[2]
var v_storageContainerPath = '${p_storageBlobPrimaryEndpoint}${v_storageContainerName}'


///////////////////////////////////////////////////////////////////////////////////////////////////////
// Section for Bicep resources
///////////////////////////////////////////////////////////////////////////////////////////////////////


resource sqlServerName 'Microsoft.Sql/servers@2021-05-01-preview' existing = {
  name: p_sqlServerName
}

resource sqlDB 'Microsoft.Sql/servers/databases@2021-05-01-preview' existing = {
  parent: sqlServerName
  name: p_sqlDBName
 }

resource SQLServerVulnerabilityAssesment  'Microsoft.Sql/servers/databases/vulnerabilityAssessments@2021-05-01-preview' = {
  name: 'default'
  parent: sqlDB
  properties: {
    recurringScans: {
      emails: p_vulnerabilityScanEmails
      emailSubscriptionAdmins: p_emailSubscriptionAdmins
      isEnabled: p_isRecurringScanEnabled
    }
    storageAccountAccessKey: p_storageAccountAccessKey
    storageContainerPath: v_storageContainerPath
  }
}

///////////////////////////////////////////////////////////////////////////////////////////////////////
// Section for Bicep Output
///////////////////////////////////////////////////////////////////////////////////////////////////////
